<html><head><meta charset="utf-8"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous"><style>.markdown-body hr::after,.markdown-body::after{clear:both}.loopLine,.messageLine0{marker-end:"url(#arrowhead)"}@font-face{font-family:octicons-link;src:url(data:font/woff;charset=utf-8;base64,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) format('woff')}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";line-height:1.5;word-wrap:break-word}.markdown-body .pl-c{color:#969896}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#0086b3}.markdown-body .pl-e,.markdown-body .pl-en{color:#795da3}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#333}.markdown-body .pl-ent{color:#63a35c}.markdown-body .pl-k{color:#a71d5d}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#183691}.markdown-body .pl-smw,.markdown-body .pl-v{color:#ed6a43}.markdown-body .pl-bu{color:#b52a1d}.markdown-body .pl-c2,.markdown-body .pl-ii{color:#f8f8f8;background-color:#b52a1d}.markdown-body .pl-c2::before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#63a35c}.markdown-body .pl-ml{color:#693a17}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#1d3e81}.markdown-body .pl-mq{color:teal}.markdown-body .pl-mi{font-style:italic;color:#333}.markdown-body .pl-mb{font-weight:700;color:#333}.markdown-body .pl-md{color:#bd2c00;background-color:#ffecec}.markdown-body .pl-mi1{color:#55a532;background-color:#eaffea}.markdown-body .pl-mc{color:#ef9700;background-color:#ffe3b4}.markdown-body .pl-mi2{color:#d8d8d8;background-color:grey}.markdown-body .pl-mdr{font-weight:700;color:#795da3}.markdown-body .pl-mo{color:#1d3e81}.markdown-body .pl-ba{color:#595e62}.markdown-body .pl-sg{color:silver}.markdown-body .pl-corl{text-decoration:underline;color:#183691}.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body hr::after,.markdown-body hr::before,.markdown-body::after,.markdown-body::before{display:table;content:""}.markdown-body a{background-color:transparent;-webkit-text-decoration-skip:objects;color:#0366d6;text-decoration:none}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body hr{box-sizing:content-box}.markdown-body input{font:inherit;margin:0;overflow:visible;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body td,.markdown-body th{padding:0}.markdown-body blockquote{margin:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body .task-list-item,ul.table-of-contents{list-style-type:none}.markdown-body dd{margin-left:0}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body .pl-0{padding-left:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:0}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{overflow:hidden;background:#e1e4e8;height:.25em;padding:0;margin:24px 0;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h6{color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{border-spacing:0;border-collapse:collapse;display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code::after,.markdown-body code::before{letter-spacing:-.2em;content:"\00a0"}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code::after,.markdown-body pre code::before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.node text,.noteText,div.mermaidTooltip{font-family:'trebuchet ms',verdana,arial}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body hr{border-bottom-color:#eee}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8;-webkit-text-size-adjust:none}.diff .hljs-header,.hljs-comment{color:#998;font-style:italic}.css .rule .hljs-keyword,.hljs-keyword,.hljs-request,.hljs-status,.hljs-subst,.hljs-winutils,.nginx .hljs-title{color:#333;font-weight:700}.hljs-hexcolor,.hljs-number,.ruby .hljs-constant{color:teal}.hljs-doctag,.hljs-string,.hljs-tag .hljs-value,.tex .hljs-formula{color:#d14}.hljs-id,.hljs-title,.scss .hljs-preprocessor{color:#900;font-weight:700}.hljs-list .hljs-keyword,.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type,.tex .hljs-command,.vhdl .hljs-literal{color:#458;font-weight:700}.django .hljs-tag .hljs-keyword,.hljs-rule .hljs-property,.hljs-tag,.hljs-tag .hljs-title{color:navy;font-weight:400}.hljs-attribute,.hljs-name,.hljs-variable,.lisp .hljs-body{color:teal}.hljs-regexp{color:#009926}.clojure .hljs-keyword,.hljs-prompt,.hljs-symbol,.lisp .hljs-keyword,.ruby .hljs-symbol .hljs-string,.scheme .hljs-keyword,.tex .hljs-special{color:#990073}.hljs-built_in{color:#0086b3}.hljs-cdata,.hljs-doctype,.hljs-pi,.hljs-pragma,.hljs-preprocessor,.hljs-shebang{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.diff .hljs-change{background:#0086b3}.hljs-chunk{color:#aaa}.mermaid .label{color:#333}.node circle,.node ellipse,.node polygon,.node rect{fill:#ECECFF;stroke:#CCF;stroke-width:1px}.edgePath .path{stroke:#333}.edgeLabel{background-color:#e8e8e8}.cluster rect{fill:#ffffde!important;rx:4!important;stroke:#aa3!important;stroke-width:1px!important}.cluster text{fill:#333}.actor{stroke:#CCF;fill:#ECECFF}text.actor{fill:#000;stroke:none}.actor-line{stroke:grey}.messageLine0,.messageLine1{stroke-width:1.5;stroke-dasharray:"2 2";stroke:#333}#arrowhead{fill:#333}#crosshead path{fill:#333!important;stroke:#333!important}.messageText{fill:#333;stroke:none}.labelBox{stroke:#CCF;fill:#ECECFF}.labelText,.loopText{fill:#000;stroke:none}.loopLine{stroke-width:2;stroke-dasharray:"2 2";stroke:#CCF}.note{stroke:#aa3;fill:#fff5ad}.noteText{fill:#000;stroke:none;font-size:14px}.section{stroke:none;opacity:.2}.section0{fill:rgba(102,102,255,.49)}.section2{fill:#fff400}.section1,.section3{fill:#fff;opacity:.2}.sectionTitle0,.sectionTitle1,.sectionTitle2,.sectionTitle3{fill:#333}.sectionTitle{text-anchor:start;font-size:11px;text-height:14px}.grid .tick{stroke:#d3d3d3;opacity:.3;shape-rendering:crispEdges}.grid path{stroke-width:0}.today{fill:none;stroke:red;stroke-width:2px}.task{stroke-width:2}.taskText{text-anchor:middle;font-size:11px}.taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px}.taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}.taskText0,.taskText1,.taskText2,.taskText3{fill:#fff}.task0,.task1,.task2,.task3{fill:#8a90dd;stroke:#534fbc}.taskTextOutside0,.taskTextOutside1,.taskTextOutside2,.taskTextOutside3{fill:#000}.active0,.active1,.active2,.active3{fill:#bfc7ff;stroke:#534fbc}.activeText0,.activeText1,.activeText2,.activeText3{fill:#000!important}.done0,.done1,.done2,.done3{stroke:grey;fill:#d3d3d3;stroke-width:2}.doneText0,.doneText1,.doneText2,.doneText3{fill:#000!important}.crit0,.crit1,.crit2,.crit3{stroke:#f88;fill:red;stroke-width:2}.activeCrit0,.activeCrit1,.activeCrit2,.activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}.doneCrit0,.doneCrit1,.doneCrit2,.doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}.activeCritText0,.activeCritText1,.activeCritText2,.activeCritText3,.doneCritText0,.doneCritText1,.doneCritText2,.doneCritText3{fill:#000!important}.titleText{text-anchor:middle;font-size:18px;fill:#000}.node text{font-size:14px}div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}body{margin:0;padding:0}.markdown-body{min-width:256px;max-width:978px;margin:0 auto;padding:20px;font-size:14px}.markdown-body h1{font-size:2.25em}.markdown-body h2{font-size:1.75em}.markdown-body h3{font-size:1.5em}.markdown-body h4{font-size:1.25em}.markdown-body h5,.markdown-body h6{font-size:1em}div.mermaid{text-align:center}hr.footnotes-sep{margin:64px 0 32px;height:1px}.footnotes{font-size:90%;padding-left:16px}li.footnote-item>p{margin:8px 0}.danger,.info,.success,.warning{padding:15px;margin-bottom:20px;border:1px solid transparent;border-radius:4px}.danger>p:last-child,.info>p:last-child,.success>p:last-child,.warning>p:last-child{margin-bottom:0}.success{color:#3c763d;background-color:#dff0d8;border-color:#d6e9c6}.info{color:#31708f;background-color:#d9edf7;border-color:#bce8f1}.warning{color:#8a6d3b;background-color:#fcf8e3;border-color:#faebcc}.danger{color:#a94442;background-color:#f2dede;border-color:#ebccd1}abbr[title]{cursor:help;border-bottom:1px dotted #777}ul.table-of-contents li{margin:4px 0}.markdown-body table td,.markdown-body table th{word-break:break-all}</style></head><article class="markdown-body"><p data-source-line="1">OkHttp原理学习</p>
<h1 id="~核心词" data-source-line="3"><a class="markdownIt-Anchor" href="#~核心词"></a>~核心词</h1>
<ul data-source-line="4">
<li>InterceptorChain</li>
<li>Dispatcher</li>
<li>ThreadPool</li>
<li>Cache</li>
<li>Plaform</li>
</ul>
<h1 id="~为什么选择okhttp" data-source-line="10"><a class="markdownIt-Anchor" href="#~为什么选择okhttp"></a>~为什么选择OKHTTP?</h1>
<p data-source-line="12">OkHttp是一个高效的HTTP库
- SPDY ，共享同一个Socket来处理同一个服务器的所有请求(how？相对以前的网络处理框架)
-如果SPDY不可用，则通过连接池来减少请求延时（how?线程池，减少T1+T3时间）
-无缝的支持GZIP来减少数据流量(why?没有具体去调查如何减少流量，这个需要和其他的网络处理来相对比。)
-缓存响应数据来减少重复的网络请求(how?不访问用cache，自动就减少了重复请求。)</p>
<h1 id="~架构图" data-source-line="18"><a class="markdownIt-Anchor" href="#~架构图"></a>~架构图</h1>
<div data-source-line="20" class="mermaid" data-processed="true"><svg id="mermaidChart0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 282.25 325" style="max-width:282.25px;"><style type="text/css" title="mermaid-svg-internal-css">/*  */
#mermaidChart0 .node&gt;rect { ; }
#mermaidChart0 .node text  { fill:#000; stroke:none; font-weight:300; font-family:"Helvetica Neue",Helvetica,Arial,sans-serf; font-size:14px; }
#mermaidChart0 .edgeLabel text  { fill:#000; stroke:none; font-weight:300; font-family:"Helvetica Neue",Helvetica,Arial,sans-serf; font-size:14px; }
#mermaidChart0 .cluster rect  { rx:4px; fill: rgb(255, 255, 222); rx: 4px; stroke: rgb(170, 170, 51); stroke-width: 1px; }
.markdown-body * { box-sizing: border-box;}
.mermaid .label { color: rgb(51, 51, 51);}
.node circle, .node ellipse, .node polygon, .node rect { fill: rgb(236, 236, 255); stroke: rgb(204, 204, 255); stroke-width: 1px;}
.edgePath .path { stroke: rgb(51, 51, 51);}
.edgeLabel { background-color: rgb(232, 232, 232);}
/*  */
</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath" style="opacity: 1;"><path class="path" d="M85.36383928571429,61L61.75,96.5L85.36383928571429,132" marker-end="url(#arrowhead25)" style="fill:none"></path><defs><marker id="arrowhead25" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="fill: #333"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M112.63616071428571,132L136.25,96.5L112.63616071428571,61" marker-end="url(#arrowhead26)" style="fill:none"></path><defs><marker id="arrowhead26" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="fill: #333"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M73.92410714285714,173L30.5,208.5L43.495535714285715,244" marker-end="url(#arrowhead27)" style="fill:none"></path><defs><marker id="arrowhead27" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="fill: #333"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M58.504464285714285,244L71.5,208.5L88.93303571428571,173" marker-end="url(#arrowhead28)" style="fill:none"></path><defs><marker id="arrowhead28" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="fill: #333"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M113.18526785714286,173L137.75,208.5L161.36383928571428,244" marker-end="url(#arrowhead29)" style="fill:none"></path><defs><marker id="arrowhead29" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="fill: #333"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M188.63616071428572,244L212.25,208.5L132.5,169.06512141280353" marker-end="url(#arrowhead30)" style="fill:none"></path><defs><marker id="arrowhead30" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="fill: #333"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="translate(61.75,96.5)" style="opacity: 1;"><g transform="translate(-24.5,-10.5)" class="label"><foreignObject width="49" height="21"><div style="display: inline-block; white-space: nowrap;"><span class="edgeLabel">request</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(136.25,96.5)" style="opacity: 1;"><g transform="translate(-30,-10.5)" class="label"><foreignObject width="60" height="21"><div style="display: inline-block; white-space: nowrap;"><span class="edgeLabel">response</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(30.5,208.5)" style="opacity: 1;"><g transform="translate(-10.5,-10.5)" class="label"><foreignObject width="21" height="21"><div style="display: inline-block; white-space: nowrap;"><span class="edgeLabel">put</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(71.5,208.5)" style="opacity: 1;"><g transform="translate(-10.5,-10.5)" class="label"><foreignObject width="21" height="21"><div style="display: inline-block; white-space: nowrap;"><span class="edgeLabel">get</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(137.75,208.5)" style="opacity: 1;"><g transform="translate(-24.5,-10.5)" class="label"><foreignObject width="49" height="21"><div style="display: inline-block; white-space: nowrap;"><span class="edgeLabel">request</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(212.25,208.5)" style="opacity: 1;"><g transform="translate(-30,-10.5)" class="label"><foreignObject width="60" height="21"><div style="display: inline-block; white-space: nowrap;"><span class="edgeLabel">response</span></div></foreignObject></g></g></g><g class="nodes"><g class="node" id="A" transform="translate(99,40.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-23.5" y="-20.5" width="47" height="41"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-13.5,-10.5)"><foreignObject width="27" height="21"><div style="display: inline-block; white-space: nowrap;">APP</div></foreignObject></g></g></g><g class="node" id="B" transform="translate(99,152.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-33.5" y="-20.5" width="67" height="41"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-23.5,-10.5)"><foreignObject width="47" height="21"><div style="display: inline-block; white-space: nowrap;">OkHttp</div></foreignObject></g></g></g><g class="node" id="C" transform="translate(51,264.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-30.5" y="-20.5" width="61" height="41"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-20.5,-10.5)"><foreignObject width="41" height="21"><div style="display: inline-block; white-space: nowrap;">Cache</div></foreignObject></g></g></g><g class="node" id="D" transform="translate(175,264.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-38" y="-20.5" width="76" height="41"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-28,-10.5)"><foreignObject width="56" height="21"><div style="display: inline-block; white-space: nowrap;">NetWork</div></foreignObject></g></g></g></g></g></g></svg></div><h1 id="~网络请求的流程" data-source-line="29"><a class="markdownIt-Anchor" href="#~网络请求的流程"></a>~网络请求的流程</h1>
<div data-source-line="31" class="mermaid" data-processed="true"><svg id="mermaidChart1" width="100%" xmlns="http://www.w3.org/2000/svg" style="max-width:850px;" viewBox="-50 -10 850 431"><style type="text/css" title="mermaid-svg-internal-css">/*  */
.loopLine, .messageLine0 { }
.markdown-body * { box-sizing: border-box;}
.actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);}
text.actor { fill: rgb(0, 0, 0); stroke: none;}
.actor-line { stroke: rgb(128, 128, 128);}
.messageLine0, .messageLine1 { stroke-width: 1.5px; stroke: rgb(51, 51, 51);}
#arrowhead { fill: rgb(51, 51, 51);}
#crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;}
.messageText { fill: rgb(51, 51, 51); stroke: none;}
/*  */
</style><g></g><g><line id="actor0" x1="75" y1="5" x2="75" y2="420" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">OkHttpClient</text></g><g><line id="actor1" x1="275" y1="5" x2="275" y2="420" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">RealCall</text></g><g><line id="actor2" x1="475" y1="5" x2="475" y2="420" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="400" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="37.5" class="actor" style="text-anchor: middle;">RealInterceptorChain</text></g><g><line id="actor3" x1="675" y1="5" x2="675" y2="420" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="600" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="675" y="37.5" class="actor" style="text-anchor: middle;">...CallServerInterceptor</text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">1:newCall()</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="128" class="messageText" style="text-anchor: middle;">2:excute()</text><path d="M 275,135 C 335,125 335,165 275,155" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="193" class="messageText" style="text-anchor: middle;">3:getResponseWithInterceptorChain()</text><path d="M 275,200 C 335,190 335,230 275,220" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="375" y="258" class="messageText" style="text-anchor: middle;">4:procceed()</text><line x1="275" y1="265" x2="475" y2="265" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="575" y="293" class="messageText" style="text-anchor: middle;">5:intercept()</text><line x1="475" y1="300" x2="675" y2="300" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="375" y="328" class="messageText" style="text-anchor: middle;">6:Response</text><line x1="675" y1="335" x2="75" y2="335" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3px, 3px; fill: none;"></line></g><g><rect x="0" y="355" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="392.5" class="actor" style="text-anchor: middle;">OkHttpClient</text></g><g><rect x="200" y="355" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="392.5" class="actor" style="text-anchor: middle;">RealCall</text></g><g><rect x="400" y="355" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="392.5" class="actor" style="text-anchor: middle;">RealInterceptorChain</text></g><g><rect x="600" y="355" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="675" y="392.5" class="actor" style="text-anchor: middle;">...CallServerInterceptor</text></g></svg></div><p data-source-line="40"><mark>PS</mark>:
RealInterceptorChain是一条Interceptor的链条，包含如下的Interceptor</p>
<ul data-source-line="43">
<li>RetryAndFollowUpInterceptor:处理重试机制，其中有一个recover的方案，主要做router的备选。</li>
<li>BridgeInterceptor:对响应的Header进行处理和检查,GZIP和Cookies处理。</li>
<li>CacheInterceptor:缓存处理，如果服务器返回HTTP_NOT_MODIFIED = 304，说明数据没有变化，我们直接使用缓存即可。（这个对优化蛮有用的）</li>
<li>ConnectInterceptor：连接server。</li>
<li>CallServerInterceptor是链条的最后一个环节，读取Response（Header+Body）</li>
</ul>
<p data-source-line="49">我们可以往链条中加入自己的Interceptor对Response做处理，加入的interceptor在链条的头部。
设计优势（星）：用一条链条，把网络连接的各个环节丢到各个Interceptor中分环节处理，权责分明，缓存机制。</p>
<h1 id="~如何缓存" data-source-line="52"><a class="markdownIt-Anchor" href="#~如何缓存"></a>~如何缓存？</h1>
<p data-source-line="54">缓存处理在CacheInterceptor（先确定需要用networkreponse么？不需要，则直接用cache;需要则确定一下code=HTTP_NOT_MODIFIED,if yes 则直接用cache）</p>
<pre data-source-line="56"><code class="hljs"><span class="hljs-keyword">@Override</span> 
<span class="hljs-keyword">public</span> Response intercept(Chain chain) throws IOException {
    Response cacheCandidate = cache != <span class="hljs-literal">null</span>
        ? cache.get(chain.request())
        : <span class="hljs-literal">null</span>;

    <span class="hljs-built_in">long</span> now = System.currentTimeMillis();

    CacheStrategy strategy = <span class="hljs-keyword">new</span> CacheStrategy.Factory(now, chain.request(), cacheCandidate).get();
    Request networkRequest = strategy.networkRequest;
    Response cacheResponse = strategy.cacheResponse;

    <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span>) {
      cache.trackResponse(strategy);
    }

    <span class="hljs-keyword">if</span> (cacheCandidate != <span class="hljs-literal">null</span> &amp;&amp; cacheResponse == <span class="hljs-literal">null</span>) {
      closeQuietly(cacheCandidate.<span class="hljs-keyword">body</span>()); <span class="hljs-comment">// The cache candidate wasn't applicable. Close it.</span>
    }

    <span class="hljs-comment">// If we're forbidden from using the network and the cache is insufficient, fail.</span>
    <span class="hljs-keyword">if</span> (networkRequest == <span class="hljs-literal">null</span> &amp;&amp; cacheResponse == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Response.Builder()
          .request(chain.request())
          .protocol(Protocol.HTTP_1_1)
          .code(<span class="hljs-number">504</span>)
          .message(<span class="hljs-string">"Unsatisfiable Request (only-if-cached)"</span>)
          .<span class="hljs-keyword">body</span>(Util.EMPTY_RESPONSE)
          .sentRequestAtMillis(-<span class="hljs-number">1L</span>)
          .receivedResponseAtMillis(System.currentTimeMillis())
          .build();
    }

    <span class="hljs-comment">// If we don't need the network, we're done.</span>
    <span class="hljs-keyword">if</span> (networkRequest == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> cacheResponse.newBuilder()
          .cacheResponse(stripBody(cacheResponse))
          .build();
    }

    Response networkResponse = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      networkResponse = chain.proceed(networkRequest);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-comment">// If we're crashing on I/O or otherwise, don't leak the cache body.</span>
      <span class="hljs-keyword">if</span> (networkResponse == <span class="hljs-literal">null</span> &amp;&amp; cacheCandidate != <span class="hljs-literal">null</span>) {
        closeQuietly(cacheCandidate.<span class="hljs-keyword">body</span>());
      }
    }

<span class="hljs-comment">//精华---请求network 如果code=HTTP_NOT_MODIFIED,服务器没有改动数据，则用缓存。</span>
    <span class="hljs-comment">// If we have a cache response too, then we're doing a conditional get.</span>
    <span class="hljs-keyword">if</span> (cacheResponse != <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (networkResponse.code() == HTTP_NOT_MODIFIED) {
        Response response = cacheResponse.newBuilder()
            .headers(combine(cacheResponse.headers(), networkResponse.headers()))
            .sentRequestAtMillis(networkResponse.sentRequestAtMillis())
            .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis())
            .cacheResponse(stripBody(cacheResponse))
            .networkResponse(stripBody(networkResponse))
            .build();
        networkResponse.<span class="hljs-keyword">body</span>().close();

        <span class="hljs-comment">// Update the cache after combining headers but before stripping the</span>
        <span class="hljs-comment">// Content-Encoding header (as performed by initContentStream()).</span>
        cache.trackConditionalCacheHit();
        cache.update(cacheResponse, response);
        <span class="hljs-keyword">return</span> response;
      } <span class="hljs-keyword">else</span> {
        closeQuietly(cacheResponse.<span class="hljs-keyword">body</span>());
      }
    }

    Response response = networkResponse.newBuilder()
        .cacheResponse(stripBody(cacheResponse))
        .networkResponse(stripBody(networkResponse))
        .build();

    <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (HttpHeaders.hasBody(response) &amp;&amp; CacheStrategy.isCacheable(response, networkRequest)) {
        <span class="hljs-comment">// Offer this request to the cache.</span>
        CacheRequest cacheRequest = cache.put(response);
        <span class="hljs-keyword">return</span> cacheWritingResponse(cacheRequest, response);
      }

      <span class="hljs-keyword">if</span> (HttpMethod.invalidatesCache(networkRequest.method())) {
        <span class="hljs-keyword">try</span> {
          cache.remove(networkRequest);
        } <span class="hljs-keyword">catch</span> (IOException ignored) {
          <span class="hljs-comment">// The cache cannot be written.</span>
        }
      }
    }

    <span class="hljs-keyword">return</span> response;
  }</code></pre><h1 id="~线程池" data-source-line="154"><a class="markdownIt-Anchor" href="#~线程池"></a>~线程池</h1>
<pre data-source-line="156"><code class="hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-function">ExecutorService <span class="hljs-title">executorService</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (executorService == <span class="hljs-keyword">null</span>) {
      executorService = <span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">0</span>, Integer.MAX_VALUE, <span class="hljs-number">60</span>, TimeUnit.SECONDS,
          <span class="hljs-keyword">new</span> SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(<span class="hljs-string">"OkHttp Dispatcher"</span>, <span class="hljs-keyword">false</span>));
    }
    <span class="hljs-keyword">return</span> executorService;
  }</code></pre><p data-source-line="165">这个没啥好说的，</p>
<ul data-source-line="166">
<li>表示池子可以没有线程，大家做完任务之后，都可以Go Home,不用值班。</li>
<li>MAX_VALUE：一个池子，可以容纳MAX_VALUE的线程；</li>
<li>60：一个线程完成任务之后，60秒内处于空闲状态就干掉它；</li>
<li>TimeUnit.SECONDS：计时单位为second;</li>
<li>new SynchronousQueue&lt;Runnable&gt;(): Runnable队列；</li>
<li>Util.threadFactory("OkHttp Dispatcher", false)：单例的线程池，负责日志输出。</li>
</ul>
<h1 id="~gzip-解压" data-source-line="173"><a class="markdownIt-Anchor" href="#~gzip-解压"></a>~GZIP 解压</h1>
<p data-source-line="174">--BridgeInterceptor</p>
<h1 id="~平台兼容性" data-source-line="176"><a class="markdownIt-Anchor" href="#~平台兼容性"></a>~平台兼容性</h1>
<p data-source-line="177">OkHttp 兼容Android 2.3+
利用反射，兼容不同API的差别性。</p>
<pre data-source-line="180"><code class="hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Platform buildIfSupported() {
    <span class="hljs-comment">// Attempt to find Android 2.3+ APIs.</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">Class</span>&lt;?&gt; sslParametersClass;
      <span class="hljs-keyword">try</span> {
        sslParametersClass = <span class="hljs-keyword">Class</span>.forName(<span class="hljs-string">"com.android.org.conscrypt.SSLParametersImpl"</span>);
      } <span class="hljs-keyword">catch</span> (ClassNotFoundException e) {
        <span class="hljs-comment">// Older platform before being unbundled.</span>
        sslParametersClass = <span class="hljs-keyword">Class</span>.forName(
            <span class="hljs-string">"org.apache.harmony.xnet.provider.jsse.SSLParametersImpl"</span>);
      }

      OptionalMethod&lt;Socket&gt; setUseSessionTickets = <span class="hljs-keyword">new</span> OptionalMethod&lt;&gt;(
          <span class="hljs-keyword">null</span>, <span class="hljs-string">"setUseSessionTickets"</span>, <span class="hljs-keyword">boolean</span>.<span class="hljs-keyword">class</span>);
      OptionalMethod&lt;Socket&gt; setHostname = <span class="hljs-keyword">new</span> OptionalMethod&lt;&gt;(
          <span class="hljs-keyword">null</span>, <span class="hljs-string">"setHostname"</span>, String.<span class="hljs-keyword">class</span>);
      OptionalMethod&lt;Socket&gt; getAlpnSelectedProtocol = <span class="hljs-keyword">null</span>;
      OptionalMethod&lt;Socket&gt; setAlpnProtocols = <span class="hljs-keyword">null</span>;

      <span class="hljs-comment">// Attempt to find Android 5.0+ APIs.</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">Class</span>.forName(<span class="hljs-string">"android.net.Network"</span>); <span class="hljs-comment">// Arbitrary class added in Android 5.0.</span>
        getAlpnSelectedProtocol = <span class="hljs-keyword">new</span> OptionalMethod&lt;&gt;(<span class="hljs-keyword">byte</span>[].<span class="hljs-keyword">class</span>, <span class="hljs-string">"getAlpnSelectedProtocol"</span>);
        setAlpnProtocols = <span class="hljs-keyword">new</span> OptionalMethod&lt;&gt;(<span class="hljs-keyword">null</span>, <span class="hljs-string">"setAlpnProtocols"</span>, <span class="hljs-keyword">byte</span>[].<span class="hljs-keyword">class</span>);
      } <span class="hljs-keyword">catch</span> (ClassNotFoundException ignored) {
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AndroidPlatform(sslParametersClass, setUseSessionTickets, setHostname,
          getAlpnSelectedProtocol, setAlpnProtocols);
    } <span class="hljs-keyword">catch</span> (ClassNotFoundException ignored) {
      <span class="hljs-comment">// This isn't an Android runtime.</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
  }</code></pre><p data-source-line="218">附：
<a href="https://github.com/square/okhttp">https://github.com/square/okhttp</a></p>
</article><body></body></html>